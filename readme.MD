## üèóÔ∏è Infra Architecture

<p align="center">
  <img src="tf-infra-dev.drawio.svg"
       alt="Infrastructure Architecture"
       width="900">
</p>


#### VPC:
* We created a VPC with name **expense-dev-vpc** and inside VPC:
    1. We created 3 subnets:
        - *Public, Private, & Database* subnets in 2 availability zones (us-east-1a & us-east-1b)
    2. We created *Internet Gateway* and attached to VPC
    3. We created route tables:
        - *Public, Private, & Database* and their association
    4. We created a *NAT Gateway*
    5. We created routes for the route tables
    6. Established Peering connection between *expense-dev-vpc* and *default-vpc* and routes are created for peering.

#### Security Groups:

<img src="sg-rules.svg" 
     alt="Infrastructure Architecture"
     width="900">

* We created security groups
    1. *expense-dev-backend*    : Security group for backend servers
    2. *expense-dev-bastion*    : Security group for bastion servers
    3. *expense-dev-db*         : Security group for database servers
    4. *expense-dev-frontend*   : Security group for frontend servers
    5. *expense-dev-vpn*        : Security group for VPN
    6. *expense-dev-web-alb*    : SG for Web ALB Instances
    7. *expense-dev-app-alb*    : Security group for App ALB

* Created security group rules:
    1. *expense-dev-app-alb* : Port: 80, Inbound from `expense-dev-frontend & expense-dev-vpn` ; Outboud: Eveywhere (0.0.0.0/0)
    2. *expense-dev-web-alb* : Port: 80,443, Inbound from everywhere HTTP & HTTPS. Outbound: Everywhere
    3. *expense-dev-vpn*     : Port: 22,443,943,1194. Inbound & Outbound from everywhere 
    4. *expense-dev-frontend* : Port: 22,80. Inbound from `expense-dev-bastion` on port 22 & Outbound:Everywhere
    5. *expense-dev-db*      : Port: 3306, Inbound from `expense-dev-bastion, expense-dev-backend, & expense-dev-vpn`. Outbound: Everywhere
    6. *expense-dev-bastion* : Port: 22, Inbound & Outbound from Everywhere
    7. *expense-dev-backend* : Inbound: `expense-dev-vpn & expense-dev-bastion` on port 22; `expense-dev-app-alb & expense-dev-vpn` on port 8080. Outbound Everywhere.

#### Bastion:
* We created a **Bastion Server** in public subnet and installed MySQL on the server using *UserData*. This server connects to the Backend instances that are in Private Subnet. Later we moved to VPN connection instead of Bastion Server.


#### DB (Amazon RDS):
1.  Using Terraform AWS RDS Module: terraform-aws-modules/rds/aws we created DB Instance.
2. Created Route53 *db-dev.surya-devops.site* record for the RDS endpoint in existing hosted zone.

#### OpenVPN:
1. Used AWS-Marketplace AMI for OpenVPN. 
2. Launched in public subnet and associated the security group.

#### APP ALB:
* Created Application Load Balancer **expense-dev-app-alb** 
* Created a HTTP listener and associated its arn with *expense-dev-app-alb* arn
* Created a fixed response "This is the default response for the application load balancer" for this http listener.
* Created Route 53 ALIAS A record `*.app-dev.surya-devops.site` that routes traffic from the application domain to an Application Load Balancer (ALB).
    - The alias.name points to the ALB DNS name generated by AWS
    - The alias.zone_id uses the ALB‚Äôs hosted zone ID (AWS-managed, region-specific)
    - Using an ALIAS record allows routing to the ALB without hard-coding IP addresses
    - Supports wildcard domains (e.g., *.app-dev) and works at the root level
    - Automatically adapts to ALB scaling and IP changes
* For expense-dev-app-alb there are 2 listener rules:

    1. If Host header (value) = backend.app-dev.surya-devops.site then:
        Forward to target group "expense-dev-backend"
        where we can check http://backend.app-dev.surya-devops.site/health , http://backend.app-dev.surya-devops.site/transaction etc. 
    
    2. Last (Default): If no other rule applies then it will return fixed response:
        "This is the default response for the application load balancer"

#### üß© Backend Infrastructure Provisioning
This module provisions and manages the backend application infrastructure using Terraform, following an AMI-based Auto Scaling pattern.

üñ•Ô∏è Backend EC2 Instance (AMI Creation)
* Launches a temporary EC2 instance using the official EC2 Terraform module
* Instance is created in a private subnet with a backend security group
* A backend setup script (backend.sh) is copied and executed via SSH
* Provisioning is re-triggered only if the instance is replaced

    üì¶ Custom AMI Workflow
###### After successful provisioning:
* The EC2 instance is stopped
* A custom AMI is created from the configured instance
* The original instance is terminated
* This ensures application setup runs once and is reused consistently

    üéØ Backend Target Group
* Creates an ALB target group for the backend service
* Uses HTTP on port 8080
* Configures health checks on the /health endpoint
* Integrates with the Application Load Balancer

    üöÄ Launch Template
* Defines a launch template using the custom backend AMI
* Configures instance type, security groups, and tagging
* Ensures the latest template version is always used

    üìà Auto Scaling Group (ASG)
* Manages backend EC2 instances using an Auto Scaling Group
* Desired capacity: 1 (scales up to 5)
* Uses rolling instance refresh on launch template changes
* Integrated with the ALB target group for health checks

    üìä Auto Scaling Policy
* Configures target tracking scaling
* Scales based on average CPU utilization
* Maintains CPU around 10% for efficient resource usage

    üåê ALB Listener Rule
* Routes traffic from the Application Load Balancer to the backend
* Uses host-based routing
    - Example: backend.app-dev.example.com

* Requests matching the host header are forwarded to the backend target group


#### üîê ACM Certificate and DNS Validation

This configuration provisions an AWS Certificate Manager (ACM) certificate and validates it using DNS validation via Route 53.

    üìú ACM Certificate
* Creates a wildcard SSL/TLS certificate for the domain: `*.surya-devops.site`
* Uses DNS validation, which is recommended for automation and renewals
* Tags the certificate using project and environment metadata
* This certificate can be used with services such as:
    - Application Load Balancer (HTTPS)
    - CloudFront
    - API Gateway

    üåê Route 53 DNS Validation Records
* Automatically creates the required CNAME validation records in Route 53
* Uses for_each to support wildcard and future additional domain names
* Records are created in an existing public hosted zone
* Short TTL (60s) enables faster validation
* These records prove domain ownership to AWS.

    ‚úÖ Certificate Validation
* Links the ACM certificate with the Route 53 validation records
* Completes validation once DNS records are available
* Ensures the certificate reaches the ISSUED state before use
* Terraform waits for successful validation before proceeding with dependent resources.

#### üåê Web Application Load Balancer (ALB) and DNS Configuration
This configuration provisions a public Application Load Balancer (ALB) with HTTP and HTTPS listeners and exposes it via Amazon Route 53 using an ALIAS record.

    ‚öñÔ∏è Application Load Balancer
* Creates an internet-facing Application Load Balancer
* Deployed across public subnets for high availability
* Associated with a dedicated security group
* Used as the primary entry point for web traffic
* Deletion protection is disabled for non-production environments

    üîä HTTP Listener (Port 80)

* Listens for incoming HTTP traffic on port 80
* Returns a fixed response by default
* Acts as a placeholder until routing rules or redirects are configured

    üîê HTTPS Listener (Port 443)

* Listens for secure HTTPS traffic on port 443
* Uses an ACM-managed SSL/TLS certificate
* Enforces a standard AWS SSL security policy
* Provides a default fixed response for unmatched requests
* This ensures encrypted communication between clients and the load balancer.

    üåç Route 53 DNS Integration
* Creates a Route 53 ALIAS A record pointing to the ALB
* Uses an existing public hosted zone
* DNS name format: `web-<environment>.<domain>`
* Automatically tracks ALB IP changes without manual updates

* For expense-dev-web-alb 2 listener rules:
 
    1. If http://web-dev.surya-devops.site/ == on HTTP (port: 80) then it will return fixed response:
        "This is the default response for the WEB ALB"

    2. If https://web-dev.surya-devops.site/ == on HTTPS (port: 443) then it will return fixed response:
        "This is the default response for the WEB ALB HTTPS"
    


